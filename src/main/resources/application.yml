spring:
  profiles:
    active: local

  # Read/Write 분리 DataSource 설정
  # @Transactional(readOnly = true) → Replica
  # @Transactional(readOnly = false) → Primary
  # 프로덕션 환경에서는 application-prod.yml에서 Primary/Replica URL을 분리 설정
  datasource:
    # Primary (Write) - 기본 설정
    primary:
      driver-class-name: org.h2.Driver
      url: jdbc:h2:mem:pointdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
      username: sa
      password:
      hikari:
        pool-name: PrimaryPool
        maximum-pool-size: 40
        minimum-idle: 20
        connection-timeout: 3000
        validation-timeout: 1000
        idle-timeout: 300000
        max-lifetime: 1800000
        leak-detection-threshold: 30000

    # Replica (Read) - 로컬/테스트에서는 Primary와 동일 DB
    replica:
      driver-class-name: org.h2.Driver
      url: jdbc:h2:mem:pointdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
      username: sa
      password:
      hikari:
        pool-name: ReplicaPool
        maximum-pool-size: 30
        minimum-idle: 10
        connection-timeout: 3000
        validation-timeout: 1000
        idle-timeout: 300000
        max-lifetime: 1800000
        read-only: true

  jpa:
    hibernate:
      ddl-auto: none
    show-sql: false
    open-in-view: false              # 지연 로딩 방지, 성능 향상
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.H2Dialect
        jdbc:
          time_zone: UTC             # DB에 UTC로 저장 (서버 타임존 KST와 무관)
          batch_size: 50             # 배치 INSERT/UPDATE 크기
        order_inserts: true          # INSERT 쿼리 정렬 (배치 효율화)
        order_updates: true          # UPDATE 쿼리 정렬 (배치 효율화)

  sql:
    init:
      mode: never  # DataSourceConfig에서 직접 초기화

# SQL 초기화 설정 (DataSourceConfig에서 사용)
datasource-init:
  schema-location: classpath:schema.sql
  data-location: classpath:data.sql

  h2:
    console:
      enabled: false

server:
  port: 8083

# Actuator - 내부 서비스용 엔드포인트만 노출 (보안)
management:
  endpoints:
    web:
      exposure:
        include: health,prometheus   # 최소한의 노출 (K8s probes + metrics)
      base-path: /actuator
    enabled-by-default: false        # 기본 비활성화
  endpoint:
    health:
      enabled: true
      show-details: never            # 상세 정보 숨김 (보안)
      probes:
        enabled: true                # K8s liveness/readiness probes
    prometheus:
      enabled: true
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true
  prometheus:
    metrics:
      export:
        enabled: true

# 분산락 설정
distributed-lock:
  wait-time-ms: 3000        # 락 획득 최대 대기 시간 (ms)
  lease-time-ms: 30000      # 락 자동 해제 시간 (ms), -1이면 Watchdog 자동 연장
  max-retry-attempts: 4     # 최대 재시도 횟수
  retry-delays-ms: 0,200,500,1000  # 시도별 대기 시간 (ms)
